<script src="/penpal.js"></script>
<script src="/pages/_fixtureHelpers.js"></script>
<script>
  let parentApiPromise;

  parentApiPromise = PenpalFixture.connect({
    methods: {},
    allowedOrigins: ['*'],
  }).promise;

  window.addEventListener('message', async (event) => {
    const message = event.data;

    if (
      !message ||
      typeof message !== 'object' ||
      message.fixture !== 'connectionDestroyedProbe' ||
      message.type !== 'REQUEST_ADD_USING_PARENT'
    ) {
      return;
    }

    try {
      const parentApi = await parentApiPromise;
      const result = await parentApi.add(3, 6);
      window.parent.postMessage(
        {
          fixture: 'connectionDestroyedProbe',
          type: 'RESULT',
          result,
        },
        '*'
      );
    } catch (error) {
      window.parent.postMessage(
        {
          fixture: 'connectionDestroyedProbe',
          type: 'RESULT_ERROR',
          code: error?.code,
        },
        '*'
      );
    }
  });
</script>
